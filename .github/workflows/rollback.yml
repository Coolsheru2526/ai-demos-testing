name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      rollback_tag:
        description: "Docker image tag to rollback to"
        required: true
        default: latest-stable

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set rollback version
      run: |
        echo "Rolling back to tag: ${{ github.event.inputs.rollback_tag }}"

    - name: Update deployment file
      run: |
        sed -i "s/image: .*/image: yourdockerhubusername\/webops-test:${{ github.event.inputs.rollback_tag }}/" app/deployment.yaml

    - name: Set up Git credentials
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

    - name: Commit rollback changes
      run: |
        git add .
        git commit -m "Rollback to ${{ github.event.inputs.rollback_tag }}"
        git push

    - name: Notify Rollback Complete
      run: echo "Rollback successful!"